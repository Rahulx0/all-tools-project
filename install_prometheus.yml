- name: Install Prometheus and Node Exporter
  hosts: all
  become: yes
  tasks:
    - name: Install Prometheus and Node Exporter packages
      apt:
        name:
          - prometheus
          - prometheus-node-exporter
        state: present
        update_cache: yes

    - name: Ensure services are started and enabled
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - prometheus
        - prometheus-node-exporter

    - name: Create a complete Prometheus configuration file
      copy:
        dest: /etc/prometheus/prometheus.yml
        content: |
          global:
            scrape_interval: 15s

          scrape_configs:
            # The default job to scrape Prometheus itself.
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']

            # The new job to scrape the Node Exporter.
            - job_name: 'node_exporter'
              static_configs:
                - targets: ['localhost:9100']
      notify: Restart Prometheus

  handlers:
    - name: Restart Prometheus
      systemd:
        name: prometheus
        state: restarted